<div class="filter-projects" [class.collapsed]="collapsed">
  <div class="filter-header">
    <span class="material-symbols-outlined" *ngIf="collapsed" (click)="toggleCollapse()">chevron_right</span>
    <h3>Filter Contracts</h3>
    <button class="filter-dots" (click)="toggleFilterMenu($event)">...</button>
    <div class="filter-dots-menu" *ngIf="filterMenuOpen" (click)="$event.stopPropagation()">
      <ul>
        <li (click)="excelexport.save()">
          
           <span class="material-symbols-outlined">save_as</span>   Export Contract
           <kendo-excelexport [data]="filteredData" fileName="contracts.xlsx" #excelexport>
                  <kendo-excelexport-column field="projectId" title="Project Id"></kendo-excelexport-column>
      <kendo-excelexport-column field="contractName" title="Project Name"></kendo-excelexport-column>
      
           </kendo-excelexport>
       </li>
        <li (click)="openSaveFilter()">
      <span class="material-symbols-outlined" >save</span>  Save Filter
      </li>
        <li class="relative">
          <span class="material-symbols-outlined">filter_list</span>Load Filter
          <span class="material-symbols-outlined submenu-arrow submenu-arrow-custom">chevron_right</span>
       
          <ul class="submenu">
            <li *ngFor=" let filters of filterlist"><span *ngFor="let filter of filters | keyvalue" (click)="loadFilter(filter.value)"> {{filter.key }}</span></li> 
          </ul>
         
        </li>
          <li class="relative" (click)="openInfoPopup()">
          <span class="material-symbols-outlined">help</span>  Instruction to Use</li>
        <li class="menu-divider"></li>
        <li class="menu-instruction" ><span class="material-symbols-outlined" >info</span>Last Updated Info</li>
        <li class="menu-last-uploaded">Last uploaded: {{ lastUploadedDate }} by {{ lastUploadedBy }}</li>
      </ul>
    </div>
    <button class="collapse-btn" (click)="toggleCollapse()">
      <span class="material-symbols-outlined" *ngIf="!collapsed">chevron_left</span>
      <span class="material-symbols-outlined" *ngIf="collapsed">chevron_right</span>
    </button>
  </div>
  <div class="filter-content" *ngIf="!collapsed">
    <ng-template #searchAndPanel>
      <kendo-textbox #customInput class="searchkendo" (valueChange)="onFilterTermChange($event)" [clearButton]="true"
        placeholder="Search job number or contract name">
        <ng-template kendoTextBoxPrefixTemplate>
          <span class="material-symbols-outlined search-icon">search</span>
        </ng-template>
      </kendo-textbox>
      <div class="panelbar-wrapper">
        <div class="advanced-search-toggle" (click)="isAdvancedSearchExpanded = !isAdvancedSearchExpanded">
          <span class="material-symbols-outlined">
            {{ isAdvancedSearchExpanded ? 'keyboard_arrow_down' : 'chevron_right' }}
          </span>
          <span class="advanced-search-label">Advanced search</span>
        </div>
        <div *ngIf="isAdvancedSearchExpanded" id="filter">
          <div class="advance-search-row">
            <button class="clear-filter-link" (click)="clearAdvanceFilters()">Clear Filter</button>
          </div>
          <div class="advance-search-row">
             <kendo-expansionpanel class="advance-expansion-panel" *ngFor="let opt of searchOptions">
      <ng-template kendoExpansionPanelTitleDirective>
         <div class="custom-header">  
 
        <div class="title-group">
          <div class="main-title">{{opt.title}}</div>
          <div class="sub-title">  
            <span class="selected-values-text" >{{opt.selected }}</span></div>
        </div>
      </div>
         <span class="custom-icon k-icon k-i-folder">
          <span class="material-symbols-outlined"  (click)="deselect($event,opt.key)">
          check_indeterminate_small
        </span></span>
    </ng-template>
      
    
        <div class="content">
           <input kendoTextBox placeholder="{{opt.title}}" [(ngModel)]="formData[opt.key]"  [name]="opt.key"  class="extended-users-input" />
          <ul *ngIf="opt.values.length > 0" class="autocomplete-list">
            <li *ngFor="let item of opt.values | filterByText:formData[opt.key] ">
              <!-- | filterByText:formData[opt.key] -->
              <label class="user-checkbox">
                <kendo-checkbox [checkedState]="isUserSelected(item,opt)" (change)="toggleUserSelection(item,opt.key)" />
                <span>{{ item }}</span>
              </label>
            </li>
          </ul>
       
        </div>
      </kendo-expansionpanel>
  
         </div>
        </div>
      </div>
    </ng-template>
    <kendo-tabstrip (tabSelect)="onTabSelect($event)" class="searchTabs">
      <kendo-tabstrip-tab title="My Contracts" [selected]="activeTabIndex === 0">
        <ng-template kendoTabTitleTemplate>
          <button kendoButton look="flat" [ngClass]="{'k-selected': activeTabIndex === 0}">My Contracts</button>
        </ng-template>
        <ng-template kendoTabContent>
          <div class="content content-left-padding">
            <ng-container *ngTemplateOutlet="searchAndPanel"></ng-container>
             <div class="treeview-results-label">
              Results {{ filteredData.length || 0 }}
            </div>
            <div class="tree-parent-checkbox-row">
              <kendo-checkbox [checkedState]="allChecked" (change)="onSelectAllChange($event)"></kendo-checkbox>
              <span class="tree-parent-label">Current Projects</span>
            </div>
           <div class="iep-tree-view">
            <kendo-treeview kendoTreeViewExpandable [nodes]="myContractsFiltered" [children]="children" [hasChildren]="hasChildren"
              [filter]="filterTerm" (checkedKeysChange)="onNodeSelect($event)" textField="text"
              [kendoTreeViewCheckable]="checkableSettings" [(checkedKeys)]="checkedKeys"
              [expandedKeys]="expandedKeys">
              <ng-template kendoTreeViewNodeTemplate let-dataItem >
              {{dataItem.contractName ? dataItem.contractName : dataItem.trainName}} <span *ngIf="  dataItem.trainName && !dataItem.contractName">{{dataItem}}</span>
                <span class="material-symbols-outlined filled-star filled-star-true" *ngIf="dataItem.isFavourite=='True'" (click)="addToFavourites(dataItem.contractName ? dataItem.contractName : dataItem.trainName)">star</span>
              </ng-template>
            </kendo-treeview>
            </div>
          </div>
        </ng-template>
      </kendo-tabstrip-tab>
      <kendo-tabstrip-tab title="All Contracts" [selected]="activeTabIndex === 1">
        <ng-template kendoTabTitleTemplate>
          <button kendoButton look="flat" [ngClass]="{'k-selected': activeTabIndex === 1}">All Contracts</button>
        </ng-template>
        <ng-template kendoTabContent>
          <div class="content">
            <ng-container *ngTemplateOutlet="searchAndPanel"></ng-container>
            <!-- Treeview for All Contracts goes here -->
              <kendo-treeview kendoTreeViewExpandable [nodes]="filteredData" [children]="children" [hasChildren]="hasChildren"
              [filter]="filterTerm" (checkedKeysChange)="onNodeSelect($event)" textField="text"
              [kendoTreeViewCheckable]="checkableSettings" [(checkedKeys)]="checkedKeys"
              [expandedKeys]="expandedKeys">
              <ng-template kendoTreeViewNodeTemplate let-dataItem >
              {{dataItem.contractName ? dataItem.contractName : dataItem.trainName}} <span *ngIf="!dataItem.trainName && !dataItem.contractName">{{dataItem}}</span>
                <span class="material-symbols-outlined filled-star filled-star-true" *ngIf="(dataItem.isMyContracts=='True') && (dataItem.isFavourite=='False')" (click)="addToFavourites(dataItem.contractName ? dataItem.contractName : dataItem.trainName)">star</span>
              </ng-template>
            </kendo-treeview>
          </div>
        </ng-template>
      </kendo-tabstrip-tab>
      <kendo-tabstrip-tab title="Favourites" [selected]="activeTabIndex === 2">
        <ng-template kendoTabTitleTemplate>
          <button kendoButton look="flat" [ngClass]="{'k-selected': activeTabIndex === 2}">Favourites</button>
        </ng-template>
        <ng-template kendoTabContent>
          <div class="content">
            <ng-container *ngTemplateOutlet="searchAndPanel"></ng-container>
            <kendo-treeview kendoTreeViewExpandable [nodes]="favouritesFiltered" [children]="children" [hasChildren]="hasChildren"
              textField="text" [kendoTreeViewCheckable]="checkableSettings" [(checkedKeys)]="checkedKeys"
              [expandedKeys]="expandedKeys">
              <ng-template kendoTreeViewNodeTemplate let-dataItem>
                {{dataItem.contractName ? dataItem.contractName : dataItem.trainName}}<span *ngIf="!dataItem.trainName && !dataItem.contractName">{{dataItem}}</span>
              </ng-template>
            </kendo-treeview>
          </div>
        </ng-template>
      </kendo-tabstrip-tab>
    </kendo-tabstrip>
  </div>
</div>
<kendo-dialog *ngIf="namePopupOpen" (close)="closeFilterNamePopup()"  class="nameDialog">
  <kendo-dialog-titlebar class="nameDialogTitle">
    <h4>Add Name For Custom Filter</h4>
  </kendo-dialog-titlebar>
  <kendo-label text="Filter Name">
  <kendo-textbox [(ngModel)]="filterName" placeholder="filter name" class="nameDialogueText"></kendo-textbox>
  </kendo-label>
<kendo-dialog-actions>
  <button kendoButton (click)="closeFilterNamePopup();"> Cancel</button> <button kendoButton (click)="saveFilter()"> Save</button>
</kendo-dialog-actions>
</kendo-dialog>
<kendo-dialog *ngIf="infoPopup" (close)="closeInfoPopup()"  class="nameDialog">
  <kendo-dialog-titlebar class="infoPopupTitle">
    <h4>Information</h4>
  </kendo-dialog-titlebar>
This window referes to advance search. 
  <p>To use advance search, please select the options from the dropdown and click on the search button.</p>
  <p>To clear the filters, click on the "Clear Filter" button.</p>
  <p>To save the filter, click on the "Save Filter" button and provide a name for the filter.</p>
  <p>To load a saved filter, select it from the "Load Filter" dropdown.</p>
  <p>For more information, please refer to the user manual.</p>

</kendo-dialog>